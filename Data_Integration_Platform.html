<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸æ“šæ•´åˆ - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .cycle-card { transition: all 0.2s ease; }
        .cycle-card:hover { border-color: #f472b6; }
        .upload-success { border-style: solid !important; border-color: #10b981 !important; background-color: #ecfdf5 !important; }
        #debug-log::-webkit-scrollbar { width: 4px; }
        #debug-log::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 text-slate-800">

    <div class="max-w-6xl mx-auto px-4 py-12">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-black text-pink-700 mb-2">æ•¸æ“šæ•´åˆ <span class="text-slate-400 text-2xl">| å¥³æ€§æ•¸æ“šå°ˆæ¥­ç‰ˆ</span></h1>
        </header>

        <!-- æª”æ¡ˆä¸Šå‚³å€ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div id="workout-zone" class="bg-white p-8 rounded-2xl border-2 border-dashed border-blue-200 text-center cursor-pointer hover:bg-blue-50 transition-all shadow-sm group relative">
                <input type="file" id="workout-input" class="hidden" accept=".csv,.xlsx,.xls">
                <div id="workout-icon" class="text-blue-500 mb-3 flex justify-center text-5xl group-hover:scale-110 transition-transform">ğŸƒ</div>
                <h3 class="font-bold text-lg text-slate-700">1. ä¸Šå‚³ Workouts</h3>
                <p id="workout-name" class="text-slate-400 text-xs mt-1 font-medium">TrainingPeaks åŒ¯å‡ºæª” (csv/xlsx)</p>
                <div id="workout-badge" class="hidden absolute top-4 right-4 text-emerald-500 font-bold text-xs bg-emerald-100 px-2 py-1 rounded-full">å·²å°±ç·’</div>
            </div>

            <div id="garmin-zone" class="bg-white p-8 rounded-2xl border-2 border-dashed border-emerald-200 text-center cursor-pointer hover:bg-blue-50 transition-all shadow-sm group relative">
                <input type="file" id="garmin-input" class="hidden" accept=".csv,.xlsx,.xls">
                <div id="garmin-icon" class="text-emerald-500 mb-3 flex justify-center text-5xl group-hover:scale-110 transition-transform">âŒš</div>
                <h3 class="font-bold text-lg text-slate-700">2. ä¸Šå‚³ Garmin æ•¸æ“š</h3>
                <p id="garmin-name" class="text-slate-400 text-xs mt-1 font-medium">Garmin ç”Ÿæ´»æ•¸æ“šå¡«è¡¨å€</p>
                <div id="garmin-badge" class="hidden absolute top-4 right-4 text-emerald-500 font-bold text-xs bg-emerald-100 px-2 py-1 rounded-full">å·²å°±ç·’</div>
            </div>
        </div>

        <!-- ç”Ÿç†é€±æœŸè¨­å®š -->
        <div class="bg-white rounded-3xl shadow-sm border border-pink-100 p-8 mb-10">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-black text-pink-600 flex items-center gap-2"><span>ğŸŒ¸ ç”Ÿç†é€±æœŸè¨­å®š</span></h2>
                    <p class="text-slate-400 text-xs mt-1">ç³»çµ±å°‡æ¨™è¨»ï¼šæ¿¾æ³¡æœŸ (é–‹å§‹~æ’åµå‰) | æ’åµæ—¥ (ç•¶å¤©) | é»ƒé«”æœŸ (æ’åµå¾Œ~ä¸‹é€±æœŸé–‹å§‹å‰)</p>
                </div>
                <button id="add-cycle-btn" class="bg-pink-500 hover:bg-pink-600 text-white p-2 rounded-full shadow-lg transition-all active:scale-90">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>
            <div id="cycle-list" class="space-y-4"></div>
            <div id="no-cycle-msg" class="text-center py-6 text-slate-300 italic text-sm border-2 border-dashed border-slate-50 rounded-xl">ç›®å‰å°šç„¡é€±æœŸè¨­å®š</div>
        </div>

        <div class="text-center">
            <button id="process-btn" class="bg-slate-900 hover:bg-pink-700 text-white font-bold py-4 px-16 rounded-xl shadow-xl transition-all active:scale-95 disabled:opacity-50">
                é–‹å§‹æ•¸æ“šæ•´åˆ
            </button>
            <p id="status-msg" class="mt-4 text-sm font-bold text-blue-600 h-6"></p>
        </div>

        <!-- Debug Console -->
        <div id="debug-log" class="mt-8 p-4 bg-slate-900 text-green-400 font-mono text-[10px] rounded-xl h-32 overflow-y-auto hidden">
            <div>[ç³»çµ±åˆå§‹åŒ–å®Œæˆ]</div>
        </div>

        <!-- çµæœå±•ç¤ºå€ -->
        <div id="result-section" class="hidden mt-10 overflow-hidden rounded-2xl shadow-xl border border-slate-200 bg-white">
            <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                <span class="font-bold text-slate-700">æ•¸æ“šæ•´åˆé è¦½</span>
                <button id="download-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-md flex items-center gap-2 transition-all active:scale-95">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    ä¸‹è¼‰æ•´åˆæª”æ¡ˆ (.xlsx)
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-[11px] whitespace-nowrap">
                    <thead id="table-head" class="bg-slate-100 text-slate-500 font-bold border-b"></thead>
                    <tbody id="preview-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const OUTPUT_HEADERS = [
            "Date", "Cycle_Phase", "WorkoutType", "Distance_KM", "Duration_Min", "PowerAverage", "PowerMax", "Energy", 
            "VelocityAverage", "VelocityMax", "CadenceAverage", "CadenceMax", "HeartRateAverage", 
            "HeartRateMax", "TorqueAverage", "IF", "TSS", "Rpe", "Feeling", 
            "Measurement Time", "BBT", "Sleep Score", "RHR", "Body Battery", "Pulse Ox", "Respiration", 
            "HRV Status", "Sleep Quality", "Sleep Duration", "Sleep Need", "Bedtime", "Wake Time", "Deep", 
            "Light", "REM", "Awake / Restless", "Calories", "Pulse Ox.1", "Respiration_Awake_Avg", 
            "Respiration_Low", "Respiration_High", "Resting HR", "Max HR", "Stress_Avg", "Stress_Resting", 
            "Stress_Low", "Stress_Mid", "Stress_High", "Training Status", "HRV", "Acute Training Load"
        ];

        const MINUTE_CONVERSION_HEADERS = ["Sleep Duration", "Deep", "Light", "REM", "Awake / Restless", "Stress_Resting", "Stress_Low", "Stress_Mid", "Stress_High"];

        let workoutRaw = null;
        let garminRaw = null;

        function log(msg) {
            const el = document.getElementById('debug-log');
            if (!el) return;
            el.classList.remove('hidden');
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            el.appendChild(div);
            el.scrollTop = el.scrollHeight;
        }

        window.onload = function() {
            const workoutInput = document.getElementById('workout-input');
            const garminInput = document.getElementById('garmin-input');
            const workoutZone = document.getElementById('workout-zone');
            const garminZone = document.getElementById('garmin-zone');
            const addCycleBtn = document.getElementById('add-cycle-btn');
            const processBtn = document.getElementById('process-btn');
            const downloadBtn = document.getElementById('download-btn');

            if (workoutZone) workoutZone.onclick = () => workoutInput.click();
            if (garminZone) garminZone.onclick = () => garminInput.click();

            if (workoutInput) {
                workoutInput.onchange = async (e) => {
                    const f = e.target.files[0]; 
                    if (f) { 
                        workoutRaw = await parseFile(f); 
                        document.getElementById('workout-name').innerText = f.name; 
                        log(`Workouts å·²è®€å– ${workoutRaw.length} ç­†è³‡æ–™`);
                        updateZoneStatus('workout', true);
                    } 
                };
            }

            if (garminInput) {
                garminInput.onchange = async (e) => {
                    const f = e.target.files[0]; 
                    if (f) { 
                        garminRaw = await parseFile(f); 
                        document.getElementById('garmin-name').innerText = f.name; 
                        log(`Garmin å·²è®€å– ${garminRaw.length} ç­†è³‡æ–™`);
                        updateZoneStatus('garmin', true);
                    } 
                };
            }

            if (addCycleBtn) addCycleBtn.onclick = () => addCycleRow();
            if (processBtn) processBtn.onclick = () => startProcessing();
            if (downloadBtn) downloadBtn.onclick = () => downloadResult();
        };

        function updateZoneStatus(type, isSuccess) {
            const zone = document.getElementById(`${type}-zone`);
            const icon = document.getElementById(`${type}-icon`);
            const badge = document.getElementById(`${type}-badge`);
            if (isSuccess) { 
                zone.classList.add('upload-success'); 
                icon.innerText = 'âœ…'; 
                badge.classList.remove('hidden'); 
            } else { 
                zone.classList.remove('upload-success'); 
                icon.innerText = type === 'workout' ? 'ğŸƒ' : 'âŒš'; 
                badge.classList.add('hidden'); 
            }
        }

        function addCycleRow() {
            const cycleList = document.getElementById('cycle-list');
            const noCycleMsg = document.getElementById('no-cycle-msg');
            const id = Date.now();
            const div = document.createElement('div');
            div.className = "cycle-card grid grid-cols-1 sm:grid-cols-4 gap-4 p-4 bg-slate-50 rounded-xl border border-slate-100 relative pr-12 shadow-sm animate-in fade-in duration-200";
            div.id = `cycle-${id}`;
            div.innerHTML = `
                <div><label class="block text-[10px] font-bold text-pink-500 mb-1">æœˆç¶“é–‹å§‹</label>
                <input type="date" class="cycle-start w-full bg-white border border-slate-200 rounded-lg p-2 text-sm outline-none"></div>
                <div><label class="block text-[10px] font-bold text-pink-500 mb-1">æœˆç¶“çµæŸ</label>
                <input type="date" class="cycle-end w-full bg-white border border-slate-200 rounded-lg p-2 text-sm outline-none"></div>
                <div><label class="block text-[10px] font-bold text-pink-500 mb-1">æ’åµæ—¥</label>
                <input type="date" class="cycle-ovul w-full bg-white border border-slate-200 rounded-lg p-2 text-sm outline-none"></div>
                <div class="flex items-center justify-end h-full">
                    <button onclick="removeCycle(${id})" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 hover:text-red-500 transition-colors p-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>`;
            cycleList.appendChild(div); 
            if (noCycleMsg) noCycleMsg.classList.add('hidden');
        }

        window.removeCycle = (id) => { 
            const el = document.getElementById(`cycle-${id}`);
            if (el) el.remove(); 
            const cycleList = document.getElementById('cycle-list');
            if (cycleList && cycleList.children.length === 0) document.getElementById('no-cycle-msg').classList.remove('hidden'); 
        };

        function getCyclePhase(targetDate, cycles) {
            const d = new Date(targetDate); d.setHours(0,0,0,0);
            if (isNaN(d.getTime())) return "";
            const sorted = [...cycles].sort((a, b) => new Date(a.start) - new Date(b.start));
            for (let i = 0; i < sorted.length; i++) {
                const c = sorted[i];
                const start = new Date(c.start); start.setHours(0,0,0,0);
                const ovul = new Date(c.ovul); ovul.setHours(0,0,0,0);
                if (d.getTime() === ovul.getTime()) return "æ’åµæ—¥";
                if (d >= start && d < ovul) return "æ¿¾æ³¡æœŸ";
                const next = sorted[i + 1]; const nextStart = next ? new Date(next.start) : null;
                if (nextStart) nextStart.setHours(0,0,0,0);
                if (d > ovul) { if (!nextStart || d < nextStart) return "é»ƒé«”æœŸ"; }
            }
            return "";
        }

        function timeToMinutes(val) {
            if (!val || ["--", "æœªæˆ´éŒ¶", "æœªæ”¯æ´", "ç©ºç™½"].includes(String(val).trim())) return val;
            let s = String(val).trim();
            if (s.includes('æ™‚')) {
                const h = s.match(/(\d+)\s*æ™‚/); const m = s.match(/(\d+)\s*(?:åˆ†é˜|åˆ†)/);
                return (parseInt(h ? h[1] : 0) * 60) + parseInt(m ? m[1] : 0);
            }
            if (s.includes('åˆ†') && !s.includes(':')) { const m = s.match(/(\d+)/); return m ? parseInt(m[1]) : val; }
            if (s.includes(':')) {
                const p = s.split(':');
                if (p.length >= 2) return parseInt(p[0]) * 60 + parseInt(p[1]) + Math.round((p[2] ? parseInt(p[2]) : 0) / 60);
            }
            if (!isNaN(parseFloat(String(s).replace(/,/g, ''))) && !String(s).includes('/')) return parseFloat(String(s).replace(/,/g, ''));
            return val;
        }

        // å°ˆç”¨æ–¼ Measurement Time çš„è½‰æ›ï¼Œè¼¸å‡ºæ ¼å¼ç‚º "am 7:00"
        function convertTo12Hour(val) {
            if (!val || ["--", "æœªæˆ´éŒ¶", "æœªæ”¯æ´"].includes(String(val).trim())) return val;
            let standardized = formatTime24H(val);
            if (!standardized || standardized.indexOf(':') === -1) return val;
            
            let parts = standardized.split(':');
            let h = parseInt(parts[0]);
            let m = parts[1];
            let ampm = h >= 12 ? 'pm' : 'am';
            h = h % 12;
            if (h === 0) h = 12;
            return `${ampm} ${h}:${m}`;
        }

        // æ—¥æœŸæ­£è¦åŒ–ï¼Œè¼¸å‡ºæ ¼å¼ç‚º 2025/6/30
        function normalizeDateDisplay(val) {
            const normalized = normalizeDate(val);
            if (!normalized) return val;
            const parts = normalized.split('-'); // YYYY-MM-DD
            if (parts.length === 3) {
                return `${parts[0]}/${parseInt(parts[1])}/${parseInt(parts[2])}`;
            }
            return normalized;
        }

        function normalizeDate(val) {
            if (!val) return "";
            let s = String(val).trim().split(' ')[0].replace(/\//g, '-');
            let p = s.split('-');
            if (p.length === 3) {
                let y, m, d;
                if (p[0].length === 4) { y = p[0]; m = p[1]; d = p[2]; } 
                else { 
                    let yy = parseInt(p[2]); 
                    y = yy < 100 ? "20" + String(yy).padStart(2, '0') : String(yy); 
                    m = p[0]; d = p[1]; 
                    if (parseInt(m) > 12) [m, d] = [d, m]; 
                }
                return `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            }
            return s;
        }

        function formatTime24H(val) {
            if (!val || ["--", "æœªæˆ´éŒ¶", "æœªæ”¯æ´"].includes(String(val).trim())) return val;
            let s = String(val).trim();
            if (/^\d{3,4}$/.test(s)) { 
                const p = s.padStart(4, '0'); 
                return `${p.slice(0, 2)}:${p.slice(2, 4)}:00`; 
            }
            const match = s.match(/(ä¸Šåˆ|ä¸‹åˆ)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/);
            if (match) {
                let h = parseInt(match[2], 10); 
                if (match[1] === 'ä¸‹åˆ' && h < 12) h += 12; 
                if (match[1] === 'ä¸Šåˆ' && h === 12) h = 0;
                return `${String(h).padStart(2, '0')}:${match[3]}:${match[4] || "00"}`;
            }
            if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)) {
                let p = s.split(':');
                return `${p[0].padStart(2, '0')}:${p[1].padStart(2, '0')}:${(p[2] || "00").padStart(2, '0')}`;
            }
            return s;
        }

        function parseFile(file) {
            return new Promise((resolve, reject) => {
                const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let data = [];
                        if (isExcel) {
                            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                            data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { raw: false });
                        } else {
                            data = Papa.parse(e.target.result, { header: true, skipEmptyLines: true }).data;
                        }
                        resolve(data.map(row => {
                            const nr = {}; Object.keys(row).forEach(k => { nr[String(k).trim()] = row[k]; }); return nr;
                        }));
                    } catch (err) { reject(err); }
                };
                if (isExcel) reader.readAsArrayBuffer(file); else reader.readAsText(file);
            });
        }

        function startProcessing() {
            if (!workoutRaw || !garminRaw) { alert("è«‹å…ˆä¸Šå‚³å…©å€‹æª”æ¡ˆ"); return; }
            log("é–‹å§‹åŸ·è¡Œæ•¸æ“šé…å°å¼•æ“...");
            const cycleData = [];
            document.querySelectorAll('.cycle-card').forEach(row => {
                const s = row.querySelector('.cycle-start').value, e = row.querySelector('.cycle-end').value, o = row.querySelector('.cycle-ovul').value;
                if (s && e && o) cycleData.push({ start: s, end: e, ovul: o });
            });

            const wMap = {};
            workoutRaw.forEach(w => {
                const dk = normalizeDate(w.WorkoutDay || w.Date);
                if (dk) { if (!wMap[dk]) wMap[dk] = []; wMap[dk].push(w); }
            });

            let matchCount = 0;
            const finalData = garminRaw.map(gRow => {
                const out = {}; 
                const rawDate = gRow.Date, dKey = normalizeDate(rawDate);
                
                out["Date"] = normalizeDateDisplay(rawDate);
                out["Cycle_Phase"] = getCyclePhase(dKey, cycleData);

                const ws = wMap[dKey] || [];
                if (ws.length > 0) matchCount++;

                out["WorkoutType"] = ws.map(x => x.WorkoutType || x.Title).join(' + ');
                const totalMeters = ws.reduce((sum, x) => sum + (parseFloat(String(x.DistanceInMeters).replace(/,/g, '')) || 0), 0);
                out["Distance_KM"] = totalMeters > 0 ? (totalMeters / 1000).toFixed(2) : "";
                const totalHours = ws.reduce((sum, x) => sum + (parseFloat(String(x.TimeTotalInHours).replace(/,/g, '')) || 0), 0);
                out["Duration_Min"] = totalHours > 0 ? (totalHours * 60).toFixed(1) : "";

                ["PowerAverage", "PowerMax", "Energy", "VelocityAverage", "VelocityMax", "CadenceAverage", "CadenceMax", "HeartRateAverage", "HeartRateMax", "TorqueAverage", "IF", "TSS"].forEach(h => {
                    out[h] = ws.length > 0 ? ws[0][h] || "" : "";
                });
                out["Rpe"] = ws.map(x => x.Rpe || x.RPE).filter(Boolean).join(' / ');
                out["Feeling"] = ws.map(x => x.Feeling).filter(Boolean).join(', ');

                let pulseOxList = []; Object.keys(gRow).forEach(k => { if (k.toLowerCase().includes("pulse ox")) pulseOxList.push(gRow[k]); });
                
                const startIdx = OUTPUT_HEADERS.indexOf("Measurement Time");
                OUTPUT_HEADERS.slice(startIdx).forEach(h => {
                    let val = gRow[h] || "";
                    if (h === "Pulse Ox") val = pulseOxList[0] || "";
                    if (h === "Pulse Ox.1") val = pulseOxList[1] || "";
                    if (h === "Calories" && typeof val === "string") val = val.replace(/,/g, '');
                    
                    // åƒ…é‡å° Measurement Time åŸ·è¡Œè½‰æ›
                    if (h === "Measurement Time") {
                        val = convertTo12Hour(val);
                    }
                    // Bedtime èˆ‡ Wake Time å°‡ç›´æ¥ç”± gRow[h] å–å¾—åŸå§‹å€¼ï¼Œä¸é€²å…¥è½‰æ›é‚è¼¯
                    
                    if (MINUTE_CONVERSION_HEADERS.includes(h)) val = timeToMinutes(val);
                    out[h] = val;
                });
                return out;
            });

            log(`æ•¸æ“šæ•´åˆå®Œæˆã€‚æˆåŠŸåŒ¹é… ${matchCount} å¤©è³‡æ–™ã€‚`);
            renderPreview(finalData);
            document.getElementById('result-section').classList.remove('hidden');
            window.finalResult = finalData;
        }

        function renderPreview(data) {
            const body = document.getElementById('preview-body');
            document.getElementById('table-head').innerHTML = `<tr>${OUTPUT_HEADERS.map(h => `<th class="px-4 py-2">${h}</th>`).join('')}</tr>`;
            let start = data.findIndex(r => r.WorkoutType !== "" || r.Cycle_Phase !== "");
            if (start === -1) start = 0;
            body.innerHTML = data.slice(start, start + 30).map(row => {
                let rowStyle = row.Cycle_Phase === 'æ’åµæ—¥' ? 'bg-purple-50' : (row.Cycle_Phase === 'é»ƒé«”æœŸ' ? 'bg-orange-50/30' : (row.Cycle_Phase === 'æ¿¾æ³¡æœŸ' ? 'bg-emerald-50/30' : ''));
                return `<tr class="${rowStyle} hover:bg-slate-100 border-b">
                    ${OUTPUT_HEADERS.map(h => {
                        let val = row[h] || ""; let cls = "";
                        if (h === 'Cycle_Phase') { if (val === 'é»ƒé«”æœŸ') cls = 'text-orange-600 font-bold'; else if (val === 'æ¿¾æ³¡æœŸ') cls = 'text-emerald-600 font-bold'; else if (val === 'æ’åµæ—¥') cls = 'text-purple-600 font-black'; }
                        if (h === 'WorkoutType' && val) cls += ' text-blue-600 font-bold';
                        return `<td class="px-4 py-2 ${cls}">${val}</td>`;
                    }).join('')}
                </tr>`;
            }).join('');
        }

        function downloadResult() {
            if (!window.finalResult) return;
            const ws = XLSX.utils.json_to_sheet(window.finalResult, { header: OUTPUT_HEADERS });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Health_Data");
            XLSX.writeFile(wb, `è·‘æ­¥æ•´åˆæ•¸æ“š_Final_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
    </script>
</body>
</html>
